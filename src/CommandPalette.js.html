<script>
  (function (window, document) {
    "use strict";

    const palette = {
      initialized: false,
      options: {
        onSelect: null,
        getCommands: () => [],
      },
      overlay: null,
      input: null,
      list: null,
      emptyState: null,
      root: null,
      commands: [],
      filtered: [],
      activeIndex: -1,
    };

    function ensureStyles() {
      if (document.getElementById("command-palette-styles")) {
        return;
      }
      const style = document.createElement("style");
      style.id = "command-palette-styles";
      style.textContent = `
        .command-palette-overlay {
          position: fixed;
          inset: 0;
          background: rgba(8, 10, 16, 0.55);
          backdrop-filter: blur(4px);
          z-index: 40;
          display: flex;
          align-items: flex-start;
          justify-content: center;
          padding-top: 12vh;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.2s ease;
        }
        .command-palette-overlay.open {
          opacity: 1;
          pointer-events: auto;
        }
        .command-palette {
          width: min(640px, 92vw);
          background: rgba(16, 20, 32, 0.95);
          border-radius: 16px;
          border: 1px solid rgba(255, 255, 255, 0.08);
          box-shadow: 0 32px 60px rgba(0, 0, 0, 0.45);
          backdrop-filter: blur(18px);
          overflow: hidden;
          transform: translateY(8px);
          transition: transform 0.18s ease;
        }
        .command-palette-overlay.open .command-palette {
          transform: translateY(0);
        }
        .command-palette__input {
          width: 100%;
          padding: 16px 20px;
          border: none;
          background: rgba(255, 255, 255, 0.04);
          color: #f5f7ff;
          font-size: 1rem;
          outline: none;
        }
        .command-palette__list {
          max-height: 360px;
          overflow-y: auto;
          padding: 8px 0;
        }
        .command-palette__item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 20px;
          color: #d5dcf5;
          cursor: pointer;
          transition: background 0.15s ease;
        }
        .command-palette__item:hover,
        .command-palette__item.is-active {
          background: rgba(212, 175, 55, 0.14);
          color: #f8f4e6;
        }
        .command-palette__label {
          font-weight: 500;
        }
        .command-palette__meta {
          font-size: 0.78rem;
          color: rgba(245, 247, 255, 0.6);
          text-transform: uppercase;
          letter-spacing: 0.08em;
        }
        .command-palette__empty {
          padding: 28px 24px;
          text-align: center;
          color: rgba(245, 247, 255, 0.6);
        }
      `;
      document.head.appendChild(style);
    }

    function buildOverlay() {
      ensureStyles();
      palette.root = document.getElementById("command-palette-root");
      if (!palette.root) {
        palette.root = document.createElement("div");
        palette.root.id = "command-palette-root";
        document.body.appendChild(palette.root);
      }

      palette.overlay = document.createElement("div");
      palette.overlay.className = "command-palette-overlay";
      palette.overlay.innerHTML = `
        <div class="command-palette" role="dialog" aria-modal="true" aria-label="Command palette">
          <input type="search" class="command-palette__input" placeholder="Type a command or searchâ€¦" />
          <div class="command-palette__list" role="listbox"></div>
          <div class="command-palette__empty hidden">No results found.</div>
        </div>
      `;
      palette.root.appendChild(palette.overlay);
      palette.input = palette.overlay.querySelector(".command-palette__input");
      palette.list = palette.overlay.querySelector(".command-palette__list");
      palette.emptyState = palette.overlay.querySelector(".command-palette__empty");
    }

    function attachEvents() {
      palette.overlay.addEventListener("click", (event) => {
        if (event.target === palette.overlay) {
          palette.close();
        }
      });
      palette.input.addEventListener("input", () => filterCommands(palette.input.value));
      palette.input.addEventListener("keydown", handleInputKeydown);
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && palette.overlay.classList.contains("open")) {
          palette.close();
        }
      });
    }

    function handleInputKeydown(event) {
      const maxIndex = palette.filtered.length - 1;
      if (event.key === "ArrowDown") {
        event.preventDefault();
        if (maxIndex < 0) {
          return;
        }
        palette.activeIndex = Math.min(maxIndex, palette.activeIndex + 1);
        highlightActiveItem();
      } else if (event.key === "ArrowUp") {
        event.preventDefault();
        palette.activeIndex = Math.max(0, palette.activeIndex - 1);
        highlightActiveItem();
      } else if (event.key === "Enter") {
        event.preventDefault();
        const item = palette.filtered[palette.activeIndex];
        if (item) {
          selectCommand(item);
        }
      }
    }

    function filterCommands(query) {
      const text = String(query || "").trim().toLowerCase();
      if (!text) {
        palette.filtered = palette.commands.slice();
      } else {
        palette.filtered = palette.commands.filter((command) => {
          const haystack = [
            command.label,
            command.hint,
            command.type,
            command.id,
          ]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();
          return haystack.includes(text);
        });
      }
      palette.activeIndex = palette.filtered.length ? 0 : -1;
      renderCommandList();
    }

    function renderCommandList() {
      palette.list.innerHTML = "";
      if (!palette.filtered.length) {
        palette.emptyState.classList.remove("hidden");
        return;
      }
      palette.emptyState.classList.add("hidden");

      palette.filtered.forEach((command, index) => {
        const item = document.createElement("div");
        item.className = "command-palette__item";
        if (index === palette.activeIndex) {
          item.classList.add("is-active");
        }
        item.setAttribute("role", "option");
        item.dataset.index = String(index);
        item.innerHTML = `
          <span class="command-palette__label">${command.label}</span>
          <span class="command-palette__meta">${command.hint || command.type || ""}</span>
        `;
        item.addEventListener("mouseenter", () => {
          palette.activeIndex = index;
          highlightActiveItem();
        });
        item.addEventListener("click", () => {
          selectCommand(command);
        });
        palette.list.appendChild(item);
      });
    }

    function highlightActiveItem() {
      const items = palette.list.querySelectorAll(".command-palette__item");
      items.forEach((item, index) => {
        if (index === palette.activeIndex) {
          item.classList.add("is-active");
          item.scrollIntoView({ block: "nearest" });
        } else {
          item.classList.remove("is-active");
        }
      });
    }

    function selectCommand(command) {
      if (typeof palette.options.onSelect === "function") {
        palette.options.onSelect(command);
      }
      palette.close();
    }

    palette.init = function init(options) {
      if (palette.initialized) {
        palette.options = Object.assign(palette.options, options || {});
        return palette;
      }
      palette.options = Object.assign(palette.options, options || {});
      buildOverlay();
      attachEvents();
      palette.initialized = true;
      return palette;
    };

    palette.open = function open() {
      if (!palette.initialized) {
        palette.init();
      }
      palette.commands = normalizeCommands(
        typeof palette.options.getCommands === "function" ? palette.options.getCommands() : []
      );
      palette.filtered = palette.commands.slice();
      palette.activeIndex = palette.filtered.length ? 0 : -1;
      renderCommandList();
      palette.overlay.classList.add("open");
      setTimeout(() => palette.input.focus(), 0);
    };

    palette.close = function close() {
      palette.overlay.classList.remove("open");
      palette.input.value = "";
      palette.commands = [];
      palette.filtered = [];
      palette.activeIndex = -1;
    };

    palette.setCommands = function setCommands(commands) {
      palette.commands = normalizeCommands(commands);
      filterCommands(palette.input.value);
    };

    function normalizeCommands(commands) {
      if (!Array.isArray(commands)) {
        return [];
      }
      return commands.map((command) => ({
        id: command.id,
        label: command.label || command.title || command.name || "Command",
        type: command.type || "command",
        hint: command.hint || "",
        data: command.data || command,
      }));
    }

    window.commandPalette = palette;
  })(window, document);
</script>
